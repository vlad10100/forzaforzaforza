<template>
  <div>
    <div>RUN!</div>
    <div class="vlad"></div>
    <div>
      <div class="py-10" v-for="(activity, index) in activities2024" :key="index">
        <p>ID: {{ activity.id }}</p>
        <p>Type: {{ activity.sport_type }}</p>
        <p>Name: {{ activity.name }}</p>
        <p>Max HR: {{ activity.max_heartrate }}</p>
        <p>Date: {{ activity.start_date_local }}</p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { onMounted, watchEffect, ref } from 'vue'
import { useCommonStore } from '@/stores/common'
import { useAthleteStore } from '@/stores/athlete'
import { db } from '@/firebase'
import { collection, doc, setDoc, getDoc } from 'firebase/firestore'
import { decode } from '@googlemaps/polyline-codec'
import * as d3 from 'd3'

onMounted(() => {
  const coordinates: [number, number][] = [
    [14.58138, 121.08736],
    [14.58115, 121.08727],
    [14.58073, 121.08716],
    [14.5803, 121.08699],
    [14.58009, 121.08694],
    [14.57996, 121.08693],
    [14.57985, 121.0869],
    [14.57909, 121.08659],
    [14.57892, 121.08655],
    [14.57881, 121.08646],
    [14.57846, 121.08627],
    [14.5783, 121.08617],
    [14.57795, 121.08604],
    [14.57776, 121.08591],
    [14.57762, 121.08584],
    [14.57743, 121.08578],
    [14.57722, 121.08565],
    [14.57699, 121.08557],
    [14.57676, 121.08541],
    [14.57647, 121.08527],
    [14.57638, 121.08524],
    [14.57632, 121.08529],
    [14.57626, 121.08529],
    [14.57619, 121.08522],
    [14.57614, 121.08509],
    [14.57605, 121.08503],
    [14.57589, 121.08499],
    [14.57567, 121.08487],
    [14.57548, 121.08474],
    [14.57509, 121.08457],
    [14.57476, 121.08439],
    [14.57458, 121.08433],
    [14.57427, 121.08414],
    [14.57397, 121.084],
    [14.57394, 121.08398],
    [14.57368, 121.08384],
    [14.57359, 121.08382],
    [14.5735, 121.08377],
    [14.57336, 121.08377],
    [14.57331, 121.08368],
    [14.57325, 121.08362],
    [14.57307, 121.08355],
    [14.57302, 121.08352],
    [14.57301, 121.08349],
    [14.57302, 121.08341],
    [14.573, 121.08338],
    [14.57282, 121.08328],
    [14.57275, 121.08326],
    [14.57274, 121.08322],
    [14.57287, 121.08242],
    [14.57293, 121.08221],
    [14.57294, 121.08208],
    [14.57297, 121.08202],
    [14.57297, 121.08188],
    [14.57305, 121.08154],
    [14.57311, 121.08113],
    [14.57317, 121.08096],
    [14.57323, 121.08057],
    [14.57338, 121.07924],
    [14.57345, 121.07905],
    [14.57347, 121.07886],
    [14.57354, 121.07869],
    [14.57357, 121.07863],
    [14.57363, 121.07861],
    [14.57359, 121.07858],
    [14.57356, 121.07854],
    [14.57357, 121.07845],
    [14.5737, 121.07828],
    [14.57379, 121.07808],
    [14.574, 121.07769],
    [14.57407, 121.0775],
    [14.57435, 121.07705],
    [14.57446, 121.07692],
    [14.57457, 121.07672],
    [14.57461, 121.0767],
    [14.57463, 121.07665],
    [14.57474, 121.07651],
    [14.57494, 121.0762],
    [14.57513, 121.07598],
    [14.57543, 121.07573],
    [14.5756, 121.07557],
    [14.57587, 121.07523],
    [14.57617, 121.07491],
    [14.57627, 121.07478],
    [14.57636, 121.07463],
    [14.57648, 121.07451],
    [14.57658, 121.07437],
    [14.57673, 121.0742],
    [14.57705, 121.0738],
    [14.57712, 121.07373],
    [14.57727, 121.07353],
    [14.57734, 121.0735],
    [14.57743, 121.07355],
    [14.57747, 121.07359],
    [14.57766, 121.07368],
    [14.57769, 121.07371],
    [14.57769, 121.07373],
    [14.57777, 121.07375],
    [14.57785, 121.07383],
    [14.57793, 121.07388],
    [14.57797, 121.07393],
    [14.57797, 121.07396],
    [14.57795, 121.07394],
    [14.57796, 121.07392],
    [14.57802, 121.07394],
    [14.57817, 121.07368],
    [14.57821, 121.07366],
    [14.57827, 121.07371],
    [14.57807, 121.07361],
    [14.5779, 121.07346],
    [14.57773, 121.07338],
    [14.57771, 121.07331],
    [14.57777, 121.07321],
    [14.57788, 121.0731],
    [14.57797, 121.07294],
    [14.57814, 121.07272],
    [14.57834, 121.07252],
    [14.57841, 121.07241],
    [14.57855, 121.07227],
    [14.57862, 121.07215],
    [14.57874, 121.07203],
    [14.57891, 121.07182],
    [14.57902, 121.07173],
    [14.57918, 121.07151],
    [14.57935, 121.07132],
    [14.57932, 121.0713],
    [14.57932, 121.07127],
    [14.57928, 121.07123],
    [14.57931, 121.07115],
    [14.5793, 121.07099],
    [14.5795, 121.07046],
    [14.57958, 121.0701],
    [14.57955, 121.06981],
    [14.57949, 121.0695],
    [14.57936, 121.06917],
    [14.57926, 121.06899],
    [14.5792, 121.06891],
    [14.57911, 121.06888],
    [14.5791, 121.06887],
    [14.57907, 121.06872],
    [14.57911, 121.06864],
    [14.57911, 121.06862],
    [14.57903, 121.06858],
    [14.5789, 121.06842],
    [14.57879, 121.06833],
    [14.5787, 121.06823],
    [14.57855, 121.06811],
    [14.57832, 121.06787],
    [14.57815, 121.06772],
    [14.57799, 121.06767],
    [14.57792, 121.06762],
    [14.57752, 121.06724],
    [14.57727, 121.06685],
    [14.57721, 121.06672],
    [14.57702, 121.06641],
    [14.57691, 121.06616],
    [14.5769, 121.06607],
    [14.57693, 121.06591],
    [14.57698, 121.06584],
    [14.57698, 121.06574],
    [14.57679, 121.06572],
    [14.57669, 121.06568],
    [14.57635, 121.06541],
    [14.57631, 121.06536],
    [14.57618, 121.06504],
    [14.57618, 121.06485],
    [14.57619, 121.06476],
    [14.57634, 121.06428],
    [14.57642, 121.06422],
    [14.57644, 121.06424],
    [14.57643, 121.06417],
    [14.5764, 121.06415],
    [14.57637, 121.06407],
    [14.57633, 121.06384],
    [14.57622, 121.0636],
    [14.57613, 121.06351],
    [14.57602, 121.06333],
    [14.57589, 121.06324],
    [14.57575, 121.06319],
    [14.5756, 121.06317],
    [14.5754, 121.0631],
    [14.5753, 121.06308],
    [14.57525, 121.06304],
    [14.57525, 121.06299],
    [14.57528, 121.06296],
    [14.57523, 121.06291],
    [14.57509, 121.06294],
    [14.57503, 121.06286],
    [14.57493, 121.06263],
    [14.57475, 121.06234],
    [14.57454, 121.06214],
    [14.57437, 121.06194],
    [14.57441, 121.06191],
    [14.57443, 121.06184],
    [14.57447, 121.06177],
    [14.57485, 121.06131],
    [14.57502, 121.06106],
    [14.57503, 121.06105],
    [14.57512, 121.06113],
    [14.57506, 121.06109],
    [14.57504, 121.06105],
    [14.57505, 121.06098],
    [14.57509, 121.06091],
    [14.57528, 121.06069],
    [14.5754, 121.06052],
    [14.5758, 121.06002],
    [14.57606, 121.05973],
    [14.57627, 121.05953],
    [14.5764, 121.05931],
    [14.57661, 121.05911],
    [14.57681, 121.05883],
    [14.57685, 121.0588],
    [14.5769, 121.05882],
    [14.57704, 121.05893],
    [14.57709, 121.0589],
    [14.57705, 121.05883],
    [14.57696, 121.05876],
    [14.57698, 121.05869],
    [14.57704, 121.05861],
    [14.57711, 121.05849],
    [14.57741, 121.05817],
    [14.57788, 121.05758],
    [14.57799, 121.05746],
    [14.57809, 121.05738],
    [14.57815, 121.05738],
    [14.57825, 121.05744],
    [14.57845, 121.0576],
    [14.57854, 121.05769],
    [14.57873, 121.05782],
    [14.57887, 121.05795],
    [14.57901, 121.05805],
    [14.57921, 121.05823],
    [14.57935, 121.05834],
    [14.57957, 121.05847],
    [14.57987, 121.05873],
    [14.57999, 121.0588],
    [14.58007, 121.0589],
    [14.58016, 121.05895],
    [14.5803, 121.05907],
    [14.58044, 121.05914],
    [14.58058, 121.05924],
    [14.58083, 121.05948],
    [14.58106, 121.05968],
    [14.58117, 121.05975],
    [14.58126, 121.05985],
    [14.58154, 121.06004],
    [14.58159, 121.06011],
    [14.58168, 121.06014],
    [14.58184, 121.06019],
    [14.58205, 121.06018],
    [14.58244, 121.06015],
    [14.58277, 121.06014],
    [14.58317, 121.06008],
    [14.58367, 121.06004],
    [14.58401, 121.06005],
    [14.58421, 121.06003],
    [14.58433, 121.06005],
    [14.58429, 121.06005],
    [14.58437, 121.06001],
    [14.58463, 121.05995],
    [14.58525, 121.0599],
    [14.5853, 121.05986],
    [14.58541, 121.05979],
    [14.58559, 121.05978],
    [14.58573, 121.05971],
    [14.58581, 121.05972],
    [14.5859, 121.05976],
    [14.58611, 121.05976],
    [14.58628, 121.05983],
    [14.58666, 121.05984],
    [14.58669, 121.05989],
    [14.58674, 121.06004],
    [14.58677, 121.0603],
    [14.58681, 121.06043],
    [14.58683, 121.06047],
    [14.58686, 121.06048],
    [14.58691, 121.06056],
    [14.58695, 121.06071],
    [14.58694, 121.06085],
    [14.58688, 121.06102],
    [14.58698, 121.06103],
    [14.58706, 121.06095],
    [14.58714, 121.06097],
    [14.58722, 121.06091],
    [14.58755, 121.06086],
    [14.58774, 121.06079],
    [14.58783, 121.0607],
    [14.5879, 121.06067],
    [14.58805, 121.06063],
    [14.58825, 121.06061],
    [14.58829, 121.06067],
    [14.58835, 121.0607],
    [14.58837, 121.06074],
    [14.58846, 121.06097],
    [14.58857, 121.0611],
    [14.58874, 121.06125],
    [14.58878, 121.06129],
    [14.5888, 121.06135],
    [14.58878, 121.06155],
    [14.58876, 121.0616],
    [14.58865, 121.0617],
    [14.58854, 121.06184],
    [14.5885, 121.06193],
    [14.5885, 121.06202],
    [14.58863, 121.06215],
    [14.58881, 121.06242],
    [14.58918, 121.06278],
    [14.58924, 121.06287],
    [14.58924, 121.06292],
    [14.58919, 121.063],
    [14.58904, 121.06318],
    [14.58883, 121.06337],
    [14.58877, 121.0635],
    [14.58864, 121.06359],
    [14.58866, 121.06375],
    [14.58862, 121.06399],
    [14.58854, 121.06434],
    [14.58854, 121.06461],
    [14.58871, 121.067],
    [14.58876, 121.06733],
    [14.58879, 121.06826],
    [14.58886, 121.0687],
    [14.58887, 121.06916],
    [14.58896, 121.07038],
    [14.58901, 121.07086],
    [14.58903, 121.07119],
    [14.58902, 121.07136],
    [14.5891, 121.07224],
    [14.58911, 121.07257],
    [14.58916, 121.07287],
    [14.58919, 121.07348],
    [14.58922, 121.07362],
    [14.58931, 121.0751],
    [14.58937, 121.07572],
    [14.58938, 121.0761],
    [14.58939, 121.0762],
    [14.58939, 121.07654],
    [14.58943, 121.07707],
    [14.58942, 121.07731],
    [14.58944, 121.07749],
    [14.58938, 121.07768],
    [14.58944, 121.07774],
    [14.58949, 121.07786],
    [14.58954, 121.07837],
    [14.58952, 121.07883],
    [14.58961, 121.07946],
    [14.58959, 121.07966],
    [14.58954, 121.07977],
    [14.5895, 121.07993],
    [14.58946, 121.07999],
    [14.58943, 121.08009],
    [14.5896, 121.08025],
    [14.58963, 121.08035],
    [14.58968, 121.08067],
    [14.58967, 121.08076],
    [14.58972, 121.08123],
    [14.59005, 121.08264],
    [14.59023, 121.0837],
    [14.59044, 121.08479],
    [14.59054, 121.08568],
    [14.59054, 121.086],
    [14.59052, 121.08647],
    [14.59046, 121.08678],
    [14.59041, 121.08729],
    [14.59035, 121.08755],
    [14.59034, 121.08789],
    [14.5903, 121.08803],
    [14.59029, 121.08833],
    [14.59026, 121.08848],
    [14.59025, 121.08884],
    [14.5902, 121.08927],
    [14.59015, 121.08935],
    [14.59005, 121.08941],
    [14.5899, 121.08944],
    [14.58982, 121.08943],
    [14.58948, 121.08934],
    [14.58936, 121.08926],
    [14.58924, 121.08923],
    [14.58912, 121.08918],
    [14.58886, 121.08915],
    [14.58862, 121.08906],
    [14.5884, 121.089],
    [14.58818, 121.08897],
    [14.58794, 121.08888],
    [14.58756, 121.08878],
    [14.58707, 121.08867],
    [14.58698, 121.08867],
    [14.58689, 121.08864],
    [14.58664, 121.0886],
    [14.58639, 121.08854],
    [14.58618, 121.08851],
    [14.58586, 121.0884],
    [14.58504, 121.08822],
    [14.58449, 121.08804],
    [14.58403, 121.08795],
    [14.58367, 121.08783],
    [14.58346, 121.08779],
    [14.5827, 121.08753],
    [14.58231, 121.08748],
    [14.58164, 121.08727],
    [14.58154, 121.08727],
    [14.58121, 121.08715],
    [14.58133, 121.08715],
    [14.58145, 121.08718],
    [14.58156, 121.08724],
    [14.58175, 121.08727]
  ]
  type BoundingBox = {
    x: [number, number] | [undefined, undefined]
    y: [number, number] | [undefined, undefined]
  }
  const boundingBox: BoundingBox = {
    x: d3.extent(coordinates, (d) => d[1]),
    y: d3.extent(coordinates, (d) => d[0])
  }

  const xScale = d3
    .scaleLinear()
    .domain(boundingBox.x as [Number, Number])
    .range([5, 195])
  const yScale = d3
    .scaleLinear()
    .domain(boundingBox.y as [Number, Number])
    .range([195, 5])

  const svg = d3
    .select('.vlad')
    .append('svg')
    .attr('xmlns', 'http://www.w3.org/2000/svg')
    .attr('width', 200) // adjust based on your desired width
    .attr('height', 200) // adjust based on your desired height

  const pathGenerator = d3
    .line()
    .x((d) => xScale(d[1]))
    .y((d) => yScale(d[0]))

  const generatedPath = pathGenerator(coordinates)

  const path = svg
    .append('path')
    .datum(coordinates)
    .attr('d', generatedPath)
    .attr('fill', 'none')
    .attr('stroke', 'black')
    .attr('stroke-width', 3)
})

const commonStore = useCommonStore()
const athleteStore = useAthleteStore()

const activities2023 = ref<Activity[]>([])
const activities2024 = ref<Activity[]>([])

const auth = async (refreshToken: string) => {
  const url = 'https://www.strava.com/api/v3/oauth/token'
  const payload = {
    client_id: 116994,
    client_secret: '6a7a6e7e6b904473e89876996c9da484d8b6c777',
    refresh_token: refreshToken,
    grant_type: 'refresh_token'
  }

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        Accept: 'application/json, text/plain, */*',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    })

    const data = await response.json()
    return data
  } catch (error) {
    console.log(error)
  }
}

const getAthleteActivities = async (refreshToken: string, after: Number, before: Number) => {
  const authTokens = await auth(refreshToken)
  const access_token = authTokens.access_token
  const headers = {
    Authorization: `Bearer ${access_token}`,
    Accept: 'application/json, text/plain, */*',
    'Content-Type': 'application/json'
  }

  const url = `https://www.strava.com/api/v3/activities?before=${before}&after=${after}&per_page=200&access_token=${access_token}`

  const response = await fetch(url, {
    method: 'GET',
    headers
  })

  const data = await response.json()
  return data
}

const _2023 = 1640966400
const _2025 = 1735660800 // end of 2024
const _2024 = 1704038400 // start of 2023

type Activity = {
  id: Number
  name: String
  sport_type: String
  start_date_local: Date
  max_heartrate: Number
}

watchEffect(async () => {
  if (!commonStore.isFetchingUser) {
    if (!commonStore.signedInUser) return

    commonStore.isLoading = true
    const userId = commonStore.signedInUser.uid
    const athlete = athleteStore.athlete
    if (!athlete || !athlete.connected_to_strava) return

    const athleteDoc = doc(db, 'athletes', userId)
    const stravaRef = collection(athleteDoc, 'strava')
    const stravaDoc = doc(stravaRef, 'activities')
    const activities = await getDoc(stravaDoc)
    const data = activities.data()
    if (!data || !data[2023] || !data[2024]) {
      const stravaDoc = doc(stravaRef, 'activities')
      const data2023 = await getAthleteActivities(athlete.strava_refresh_token, _2023, _2024)
      const data2024 = await getAthleteActivities(athlete.strava_refresh_token, _2024, _2025)
      await setDoc(stravaDoc, { 2023: data2023, 2024: data2024 })

      activities2024.value = data2024[2024]
      activities2023.value = data2023[2023]
    } else {
      data[2023]
    }

    if (data) {
      activities2024.value = data[2024]
      activities2023.value = data[2023]
    }
    commonStore.isLoading = false
    return
  }
})
onMounted(() => {
  commonStore.isLoading = true
  setTimeout(() => {
    if (commonStore.isFetchingUser) return
    commonStore.isLoading = false
  }, 1000)
})
</script>

<style scoped></style>
